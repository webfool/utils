### babel
babel 用于将高版本代码转化成能兼容低版本浏览器的代码，它主要做两个事情：
- 将高版本代码转换成相同功能的代码
- 模拟高版本环境，添加高版本特性的实现

### babel 安装和使用
- 1、命令行中使用
```js
// @babel/core 是 babel 的核心包
// @babel/cli 在 node_module/.bin 目录下生成 babel 命令，用于命令行工具执行
npm i @babel/core @babel/cli -D

// package.json 配置 script
{
  "scripts": {
    "build": "babel src -d dist"
  }
}

// npx 的方式
npx babel src -d dist
```

- 2、webpack 中使用
```js
// babel-loader 用来在 webpack 中加载处理 js 文件
npm i @babel/core babel-loader -D

// webpack.config.js
const path = require('path');
module.exports = {
    entry: './src/app.js',
    output: {
        path: path.resolve(__dirname, 'dist'),
        filename: 'bundle.js'
    },
    module: {
        rules: [
            { test: /\.js$/, exclude: /node_modules/, loader: 'babel-loader' }
        ]
    }
};
```

### babel 配置文件
规则：
- 执行 babel 时，如果没有 babel.config.js，则被编译的文件往上找的是 .babelrc.js (或兼容后缀)的文件，且找到的必须在执行 babel 命令的文件夹才有效
- 如果执行 babel 命令时，配置上了 rootMode 为 'upward'，则会继续往上找 babel.config.js 文件
- 往上找文件时，会在遇到 package.json 文件时终止
- 执行 babel 有 babel.config.js 时，被编译的文件按 babel.config.js 的配置走，被编译文件能否往上查找 .babelrc.js（或兼容后缀） 的文件取决于 babel.config.js 的 babelrcRoots 配置。被编译的文件以及找到的 .babelrc.js (或兼容后缀) 文件需在 babelrcRoots 配置的路径内才能生效。

最佳实践：
- 单个 package: 在根目录下配置 .babelrc 或者 babel.config.js 都行
- 多个 package: 在根目录下配置 babel.config.js，在 babelrcRoots 配置子目录的地址，子目录根目录配置 .babelrc
｜可以在 babel.config.js 的根目录下执行 babel
｜可以在 .babelrc.js 的目录下执行 babel --root-mode upward 用于往上查找公共的 babel.config.js 配置

```js
// babel.config.js
module.exports = {
  plugins: ['@babel/plugin-transform-arrow-functions'],
  babelrcRoots: [ // 代表以下路径的文件编译支持往上查找 .babelrc.js 文件，并且找到的 .babelrc.js 文件需在 babelrcRoots 配置的路径内
    '.',
    'src/packageA'
  ]
}
```

#### Plugins 和 Presets
babel 就像一个编译器，负责：解析、转换、输出。其中编译的最小单元是 plugins，多个 plugins 组成 presets。

##### Plugins 的使用
```js
// 方式一：无配置，直接传入插件名。babel-plugin-myPlugin 使用时可以省去前缀 babel-plugin-
{
  "plugins": ['myPlugin']
}

// 方式二：可配置，传入数组 [插件名，配置对象]
{
  "plugins": [
    ['myPlugin', {key: 'value'}]
  ]
}
```
多个插件的执行顺序：由前到后。

目前常用插件为 @babel/plugin-transform-runtime，它有两个功能：
- 减少重复代码：移除 babel 内联的辅助函数，转为从 @babel/runtime 引入
- 避免污染全局变量：引入全局变量中没有的新版本功能的实现，并重写代码中的名称，如 Promise 改为 _promise

@babel/plugin-transform-runtime 用法和配置总结：
```js
{
  "plugins": [
    [
      "@babel/plugin-transform-runtime",
      {
        // 引入代码时，从 corejs@3 中引入。
        // 确认编译成从 @babel/runtime-corejs2 还是 @babel/runtime-corejs3 引入
        // 2版本只支持全局变量(如 Promise)和静态方法(如 Array.from)，3版本还支持实例的方法(如 [].includes)
        corejs: 3
        // corejs: {"version": 3, "proposals": true} // 可以设置proposals为true使得抽取和重写也能对试验性功能产生作用，一般不需要
      }
    ]
  ]
}
```
使用这个插件之后，打包文件里需要引入 @babel/runtime 的代码，所以必须先安装
> npm i @babel/runtime --save

##### Presets 的使用
```js
// 方式一：无配置，直接传入预设名。babel-preset-myPreset 使用时可以省去前缀 babel-preset-
{
  "presets": ["myPresets"]
}

// 方式二：有配置，传入数组 [预设名，配置对象]
{
  "presets": [
    ["myPresets", {key: 'value'}]
  ]
}
```
多个预设的执行顺序：由后到前。

目前常用预设为 @babel/preset-env，它可以根据你定义的浏览器版本范围或者浏览器使用比例进行转换，可以在 .browserslistrc 文件或者 @babel/preset-env 的 target 配置字段中配置，target 的优先级高于 .browserslistrc 文件。

如果不设置 target，那么会默认转为 es5。target 的配置格式：
```js
// 配置格式一：按浏览器使用比例
{
  "presets": [
    [
      "@babel/preset-env",
      {
        "targets": "> 0.25%, not dead"
      }
    ]
  ]
}

// 配置格式二：按浏览器版本
{
  "presets": [
    [
      "@babel/preset-env",
      {
        "targets": {
          "chrome": 58,
          "ie": 11
        }
      }
    ]
  ]
}
```

对于缺少的功能如何引入，可以通过设置 useBuiltIns 为 entry 或者 usage 决定：
- entry：根据入口处的代码确认
  - 【import "core-js"; 或者 import "regenerator-runtime/runtime";】则会把浏览器未支持的其它属性都引入
  - 【import "core-js/es/array";】也可以直接指定引入哪些属性，babel 会将相关的都打包进去
- usage：只引入用到的
- false：不会为没有的功能引入任何代码

对于从哪个版本的core-js 包中引入功能，可以通过 corejs 字段定义。

最佳实践：
```js
{
  "presets": [
    [
      "@babel/preset-env",
      {
        "targets": {
          "chrome": 58,
          "ie": 11
        },
        "useBuiltIns": "usage",
        "corejs": 3
      }
    ]
  ]
}
```

因为通过 @babel/preset-env 编译过的代码中需引 core-js 的文件，所以需要安装
```js
npm install --save @babel/runtime-corejs2
npm install --save @babel/runtime-corejs3
```

#### 最佳实践总结
安装包:
```js
npm i @babel/core -D // babel 核心包
npm i @babel/cli -D // 在 node_module 下生成 babel 命令的脚本包

npm i @babel/preset-env -D // 预设包，用于转换语法和填充功能
npm i @babel/plugin-transform-runtime -D // plugin，用于将引入填充功能和工具方法的路径改为 @babel/runtime-corejs3 或 2，避免全局污染和代码重复

npm i core-js@3 --save // 新功能的实现包，会全局污染
npm install @babel/runtime-corejs3 --save // 新功能的实现包和工具函数包，不会全局污染
```

配置文件:
```js
// babel.config.js
module.exports = {
  presets: [
    [
      '@babel/preset-env',
      {
        target: {
          chrome: 58,
          ie: 11
        },
        useBuiltIns: 'usage', // 没有的功能按需引入
        corejs: 3 // 填充的功能都是从 core-js 包中引入，此处数值指编译成 core-js 的 3 版本包的路径，引入之后会污染全局变量
      }
    ]
  ],
  plugins: [
    [
      '@babel/plugin-transform-runtime', // 把工具方法抽取公共，并避免污染全局
      {
        corejs: 3 // 编译成从 @babel/runtime-corejs3 取
      }
    ]
  ]
};
```